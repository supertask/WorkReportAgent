---
description: クラウド環境（Modal等）での高負荷処理やライブラリインストール時のコスト超過を防ぐためのルール
globs: **/*.py, **/*.sh
---
# クラウドコスト管理とビルド時間の最適化

Modalなどの従量課金制クラウド環境でコードを実行する場合、以下のガイドラインに従って予期せぬ高額請求を防いでください。

## 1. flash-attn などの重いライブラリのインストール

`flash-attn` や特定の CUDA 拡張を含むライブラリは、ソースコードからのビルドに数十分〜1時間以上かかる場合があります。クラウド上でビルドが走ると、その間もGPUインスタンス料金が発生します。

- **禁止事項**: クラウド実行環境（Modalの `image.pip_install` 等）で、バージョン指定なしに `pip install flash-attn` を行わないでください。環境不一致によりソースビルドがトリガーされる危険があります。
- **推奨事項**:
    - 必ず **PyTorch と CUDA のバージョンを固定** してください。
    - **ビルド済み Wheel** を使用してください。GitHub Releases 等から、環境（Python, PyTorch, CUDAバージョン）に合致する `.whl` のURLを直接指定してインストールします。

## 2. 依存関係のバージョン固定

互換性のないバージョンの組み合わせは、意図しない再ビルドや動作不良を引き起こします。

- `torch`, `cuda` (ベースイメージ), `python` のバージョンは明示的に組み合わせを確認し、固定してください。

## 3. 実行前の確認

- 初めて実行する重い処理や、環境構築を含むスクリプトを実行する際は、予想される所要時間とコストのリスクを考慮し、必要であればユーザーに警告してください。
